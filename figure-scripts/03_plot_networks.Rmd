---
output: html_document
editor_options: 
  chunk_output_type: console
---

# Plot networks in final generations

```{r}
library(data.table)
library(glue)
library(tidygraph)
library(ggraph)
library(colorspace)
library(patchwork)
```

## Load networks from default scenario

Read parameter files to subset for default parameter combination, based on the "ofi" column.

```{r}
params <- list.files(
  "data/parameters",
  pattern = "default", full.names = T
)
params <- lapply(params, fread) |>
  rbindlist(use.names = TRUE)
```

```{r}
params <- params[scenario == 1 & ((!infect_percent) &
  (costInfect == 0.25) &
  (regen_time == 50) &
  (dispersal == 2))]

data_files <- glue("data/results/networks/data_networks_{params$seed}.Rds")
```

```{r}
data_ntwk <- lapply(data_files, function(file) {
  nt <- readRDS(file)
  nt
})
```

## Degree distribution

```{r}
gen_patho_intro <- as.character(500)
gen_patho_adapt <- as.character(700)

degree_data <- lapply(
  data_ntwk, function(le) {
    le_pre <- le[[gen_patho_intro]]
    le_post <- le[[gen_patho_adapt]]
    # pre pathogen degree
    le_pre <- mutate(
      le_pre,
      degree = tidygraph::centrality_degree(
        normalized = F
      ),
      type = "pre"
    ) |>
      as_tibble()

    # post pathogen degree
    le_post <- mutate(
      le_post,
      degree = tidygraph::centrality_degree(
        normalized = F
      ),
      type = "post"
    ) |>
      as_tibble()

    rbindlist(
      list(
        le_pre,
        le_post
      )
    )
  }
) |>
  rbindlist()

# save degree data
fwrite(
  degree_data,
  "data/results/data_default_degree_distribution.csv"
)
```

```{r}
degree_data <- fread("data/results/data_default_degree_distribution.csv")
degree_data$type <- factor(degree_data$type, levels = c("pre", "post"))
```

```{r}
# popsize per sim
popsize <- 500
# how many replicates
replicates <- 10

plot_degree <-
  ggplot(degree_data) +
  geom_histogram(
    aes(
      degree,
      fill = type,
      y = ..count.. / (popsize * replicates)
    ),
    position = "identity",
    bins = 25, alpha = 0.9,
    col = NA,
    show.legend = F
  ) +
  scale_fill_discrete_diverging(
    palette = "Blue-Red",
    rev = F,
    l1 = 50,
    name = NULL,
    labels = c(
      "Pathogen-naive (G = 500)",
      "Pathogen-adapted (G = 700)"
    )
  ) +
  scale_x_continuous(
    # trans = ggallin::pseudolog10_trans,
    breaks = c(0, 10, 50, 500),
    labels = function(x) {
      scales::percent(
        accuracy = 1,
        as.numeric(x) / popsize
      )
    },
    name = "% Pop. encountered"
  ) +
  scale_y_continuous(
    # breaks = c(0, 0.1, 0.25),
    labels = scales::percent_format(accuracy = 1)
  ) +
  theme_test(
    base_family = "Arial",
    base_size = 8
  ) +
  theme(
    legend.position = "top",
    legend.key.height = unit(0.5, "mm"),
    legend.key.width = unit(2, "mm"),
    axis.text.y = element_text(
      angle = 90,
      hjust = 0.5
    ),
    plot.background = element_blank(),
    panel.background = element_blank()
  ) +
  labs(
    y = "% Indiv."
  ) +
  guides(
    fill = guide_legend()
  )
```

## Default scenario network plots

```{r}
# select a replicate
repl <- 1
# select nice network
ntwks_example <- data_ntwk[[repl]]

# get the landscape
landscape <- list.files(
  path = "data/output", pattern = as.character(params$seed[repl]),
  full.names = TRUE
) |> readRDS()
landscape <- landscape$output@landscape

# select before and after disease
ntwk_pre <- ntwks_example[[gen_patho_intro]] %>%
  activate(edges) %>%
  filter(weight > quantile(weight, probs = 0.25)) %>%
  activate(nodes)

# select a nice network. Note this may be a different replicate
# networks are plotted for illustration only
ntwks_example <- data_ntwk[[repl]]
ntwk_post <- ntwks_example[[gen_patho_adapt]] %>%
  activate(edges) %>%
  filter(weight > quantile(weight, probs = 0.25)) %>%
  activate(nodes)

# sanity check
ggraph(ntwk_pre, x = x, y = y) +
  geom_node_point(
    aes(
      fill = t_infec,
      size = assoc
    ),
    shape = 21,
    show.legend = F
  ) +
  coord_equal(
    xlim = c(0, 60),
    ylim = c(0, 60)
  )
```

```{r}
# make network figures
networkplots <- lapply(
  list(ntwk_pre, ntwk_post), function(n) {
    ggraph(n, x = x, y = y) +
      geom_point(
        data = landscape,
        aes(x, y, col = "food"),
        size = 0.05
      ) +
      geom_edge_fan(
        edge_width = 0.1,
        edge_color = "darkgrey",
        show.legend = FALSE
      ) +
      geom_node_point(
        aes(
          fill = t_infec,
          size = assoc
        ),
        shape = 21,
        colour = "grey40",
        show.legend = T
      ) +
      scale_size_continuous(
        range = c(0.1, 3)
      ) +
      scale_fill_continuous_sequential(
        palette = "Inferno",
        limit = c(1, 101),
        breaks = c(1, 50, 100),
        na.value = "lightblue"
      ) +
      scale_colour_manual(
        values = c(
          food = "forestgreen"
        ),
        name = NULL,
        labels = "Food item locations"
      ) +
      coord_cartesian(
        expand = TRUE,
        xlim = c(0, 60),
        ylim = c(0, 60)
      ) +
      theme_graph(
        base_family = "Arial",
        background = "white",
        border = T,
        base_size = 8,
        plot_margin = margin(rep(0, 3))
      ) +
      theme(
        legend.margin = margin(rep(0, 4)),
        legend.position = "top",
        legend.title = element_text(size = 6),
        legend.key.height = unit(1, units = "mm"),
        legend.key.width = unit(3, units = "mm"),
        plot.background = element_blank()
      ) +
      labs(
        fill = "Time infected"
      ) +
      guides(
        size = "none",
        edge_alpha = "none",
        colour = guide_legend(
          override.aes = list(
            size = 2
          )
        )
      )
  }
)
```

```{r}
# wrap plots
plot_networks <-
  wrap_plots(networkplots, guides = "collect", ncol = 2) &
    plot_annotation(
      tag_levels = c("A")
    ) &
    theme(
      plot.tag = element_text(
        face = "bold"
      ),
      legend.position = "bottom"
    )

ggsave(
  plot = plot_networks,
  filename = "figures/fig_networks.png",
  height = 85,
  width = 130,
  units = "mm"
)
```

## Transmission chains

```{r}
# read data
chains <- list.files(
  "data/results/transmission_chains",
  pattern = as.character(params$seed[[repl]]),
  full.names = TRUE
) |> readRDS()

# set factor levels
chains <- lapply(chains, function(g) {
  g |>
    activate(nodes) |>
    mutate(
      social_strat = factor(
        social_strat,
        levels = c("agent avoiding", "handler tracking", "agent tracking")
      )
    )
})
```

```{r}
plot_chains <- (lapply(chains, function(g) {
  ggraph(g, layout = "circlepack") +
    geom_node_circle(
      aes(fill = social_strat),
      colour = "grey40"
    ) +
    scale_fill_discrete_sequential(
      palette = "Viridis",
      l1 = 15, l2 = 80,
      rev = F,
      limits = c("agent avoiding", "handler tracking", "agent tracking"),
      order = c(1, 3, 2),
      name = NULL,
      na.value = "grey",
      labels = stringr::str_to_sentence
    ) +
    theme_graph(
      base_family = "Arial",
      background = "white",
      border = T,
      base_size = 8,
      plot_margin = margin(rep(0, 3))
    ) +
    theme(
      legend.margin = margin(rep(0, 4)),
      legend.position = "top",
      legend.title = element_text(size = 6),
      legend.key.height = unit(1, units = "mm"),
      legend.key.width = unit(3, units = "mm"),
      plot.background = element_blank()
    ) +
    labs(
      fill = "Time infected"
    ) +
    coord_equal(
      xlim = c(-21, 21),
      ylim = c(-21, 21)
    )
}) |> wrap_plots(guides = "collect", ncol = 2) &
  plot_annotation(
    tag_levels = c("A")
  ) &
  theme(
    plot.tag = element_text(
      face = "bold"
    ),
    legend.position = "top"
  ))
```

## Plot chain size

```{r}
chain_size_data <- fread("data/results/transmission_data.csv")
chain_size_data <- chain_size_data[scenario_tag == "default", ]

plot_chain_size <-
  ggplot(chain_size_data) +
  geom_col(
    aes(n_infected, freq, fill = as.factor(gen)),
    position = position_dodge(width = 0.5),
    width = 2
  ) +
  scale_fill_discrete_diverging(
    palette = "Blue-Red",
    rev = F,
    l1 = 50,
    name = NULL,
    labels = c(
      "Pathogen-naive (G = 500)",
      "Pathogen-adapted (G = 700)"
    )
  ) +
  theme_test(
    base_family = "Arial",
    base_size = 8
  ) +
  theme(
    legend.position = "top",
    legend.key.height = unit(0.5, "mm"),
    legend.key.width = unit(2, "mm"),
    axis.text.y = element_text(
      angle = 90,
      hjust = 0.5
    ),
    plot.background = element_blank(),
    panel.background = element_blank()
  ) +
  labs(
    x = "Forward infections",
    y = "Count"
  ) +
  guides(
    fill = guide_legend()
  )
```

```{r}
plot_distributions <- wrap_plots(
  plot_degree, plot_chain_size,
  guides = "collect"
) &
  theme(legend.position = "top")

plot_sociality <-
  wrap_plots(
    plot_networks,
    plot_distributions,
    plot_chains,
    design = "AA\nAA\nAA\nBB\nCC\nCC"
  ) &
    plot_annotation(
      tag_levels = c("A")
    ) &
    theme(
      plot.tag = element_text(
        face = "bold"
      ),
      legend.position = "top"
    )

# save plot
ggsave(
  plot = plot_sociality,
  filename = "figures/fig_networks_chains.png",
  height = 180,
  width = 130,
  units = "mm"
)
```

## Load networks from alternative scenarios

Read parameter files to subset for default parameter combination, based on the "ofi" column.

```{r}
params <- list.files(
  "data/parameters",
  pattern = "csv", full.names = T
)
params <- lapply(params, fread) |>
  rbindlist()
```

```{r}
params <- params[(costInfect == 0.05 & regen_time == 50) |
  (costInfect == 0.25 & regen_time == 50 & dispersal == 10)]

data_files <- glue("data/results/networks/data_networks_{params$ofi}.Rds")
```

```{r}
data_ntwk <- lapply(data_files, function(file) {
  nt <- readRDS(file)
  nt # we previously saved networks under the name nt
})
```

## Degree distribution in alternative scenarios

```{r}
degree_data <- lapply(
  data_ntwk, function(le) {
    le_pre <- le[["2500"]]
    le_post <- le[["3500"]]
    # pre pathogen degree
    le_pre <- mutate(
      le_pre,
      degree = tidygraph::centrality_degree(
        normalized = F
      ),
      type = "pre"
    ) |>
      as_tibble()

    # post pathogen degree
    le_post <- mutate(
      le_post,
      degree = tidygraph::centrality_degree(
        normalized = F
      ),
      type = "post"
    ) |>
      as_tibble()

    rbindlist(
      list(
        le_pre,
        le_post
      )
    )
  }
) |>
  rbindlist()

# save degree data
fwrite(
  degree_data,
  "data/results/data_alt_degree_distribution.csv"
)
```

```{r}
degree_data <- fread("data/results/data_alt_degree_distribution.csv")
degree_data$type <- factor(degree_data$type, levels = c("pre", "post"))

# add simulation type
degree_data[, sim_type := fcase(
  infect_percent == "percent", "percent",
  dispersal == 10, "global"
)]
```

```{r}
# popsize per sim
popsize <- 500
# how many replicates
replicates <- 10

fig_degree_alt <-
  ggplot(degree_data) +
  geom_histogram(
    aes(
      degree,
      fill = type,
      y = ..count.. / (popsize * replicates)
    ),
    bins = 15,
    col = NA,
    show.legend = F
  ) +
  geom_vline(
    xintercept = 0.1 * popsize,
    lty = 2,
    size = 0.2
  ) +
  scale_fill_discrete_diverging(
    palette = "Blue-Red",
    rev = F,
    l1 = 50
  ) +
  scale_x_continuous(
    trans = ggallin::pseudolog10_trans,
    breaks = c(0, 10, 100, 500),
    labels = function(x) {
      scales::percent(
        as.numeric(x) / popsize
      )
    },
    name = "% Pop. encountered"
  ) +
  scale_y_continuous(
    # breaks = c(0, 0.1, 0.25),
    labels = scales::percent
  ) +
  facet_grid(
    sim_type ~ type,
    labeller = labeller(
      type = c(
        post = "Post-pathogen",
        pre = "Pre-pathogen"
      ),
      sim_type = c(
        global = "Global dispersal",
        percent = "Percentage infection cost"
      )
    )
  ) +
  theme_test(
    base_family = "Arial",
    base_size = 8
  ) +
  theme(
    legend.position = "top",
    legend.key.height = unit(0.5, "mm"),
    legend.key.width = unit(2, "mm"),
    axis.text.y = element_text(
      angle = 90,
      hjust = 0.5
    ),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(
      face = "bold"
    )
  ) +
  labs(
    y = "% Indiv."
  ) +
  guides(
    fill = guide_legend()
  )
```

```{r}
ggsave(
  fig_degree_alt,
  filename = "supplement/figures/fig_degree_alt.png",
  height = 100,
  width = 120, units = "mm"
)
```
